name: PR Notification Workflow # ì›Œí¬í”Œë¡œ ì´ë¦„

on:
  pull_request:
    # PRì´ ì—´ë¦¬ê±°ë‚˜, ë‹¤ì‹œ ì—´ë¦¬ê±°ë‚˜, ì—…ë°ì´íŠ¸ë˜ê±°ë‚˜, ë‹«í˜”ì„ ë•Œ ì›Œí¬í”Œë¡œ ì‹¤í–‰
    types: [opened, reopened, synchronize, closed]

jobs:
  notify-pr-events: # PR ì´ë²¤íŠ¸ ì•Œë¦¼ì„ ë‹´ë‹¹í•˜ëŠ” Job
    runs-on: ubuntu-latest # ì‹¤í–‰ í™˜ê²½ ì§€ì •

    steps:
      - name: Checkout repository # ë¦¬í¬ì§€í† ë¦¬ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Send Discord Notification for PR Events # Discord ì•Œë¦¼ ì „ì†¡ ìŠ¤í…
        uses: actions/github-script@v6 # GitHub API í˜¸ì¶œ ë° ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ìœ„í•œ ì•¡ì…˜
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }} # GitHubì—ì„œ ê¸°ë³¸ ì œê³µí•˜ëŠ” í† í°
          script: |
            // --------------------------------------------------------
            // ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•œ Guard Clause:
            // github.eventë‚˜ github.event.pull_requestê°€ ì—†ì„ ê²½ìš° ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
            if (!github.event || !github.event.pull_request) {
              console.log("github.event or github.event.pull_request is missing. Exiting.");
              return;
            }
            // --------------------------------------------------------

            const pr = github.event.pull_request;
            const action = github.event.action; // í˜„ì¬ PR ì´ë²¤íŠ¸ì˜ ì•¡ì…˜ (opened, closed ë“±)
            
            let messageTitle = "";    // ì•Œë¦¼ ì œëª©
            let messageContent = "";  // ì•Œë¦¼ ë³¸ë¬¸ ë‚´ìš©
            let discordColor = "";    // Discord ì„ë² ë“œ ìƒ‰ìƒ (ì‹­ì§„ìˆ˜ RGB ê°’)
            let commitMessages = "";  // ì»¤ë°‹ ë©”ì‹œì§€ ëª©ë¡

            // PR ì´ë²¤íŠ¸ ì•¡ì…˜ì— ë”°ë¥¸ ì•Œë¦¼ ë‚´ìš© ë° ìƒ‰ìƒ ì„¤ì •
            if (action === 'opened' || action === 'reopened' || action === 'synchronize') {
                messageTitle = `ğŸ‰ New Pull Request Opened!`;
                discordColor = 65280; // ì´ˆë¡ìƒ‰

                const owner = github.repository.owner.login;
                const repo = github.event.repository.name;
                const prNumber = pr.number;

                // GitHub APIë¥¼ í†µí•´ PRì— ì—°ê²°ëœ ì»¤ë°‹ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const { data: commits } = await github.rest.pulls.listCommits({
                  owner,
                  repo,
                  pull_number: prNumber,
                  per_page: 5 // ìµœëŒ€ 5ê°œ ì»¤ë°‹ë§Œ í‘œì‹œ
                });

                if (commits.length > 0) {
                  commitMessages = "--- Commits ---\n";
                  commits.forEach(commit => {
                    // ì»¤ë°‹ ë©”ì‹œì§€ì˜ ì²« ì¤„ë§Œ ê°€ì ¸ì™€ì„œ í‘œì‹œ
                    commitMessages += `- ${commit.commit.message.split('\n')[0].trim()}\n`;
                  });
                  // ë§Œì•½ 5ê°œ ì´ìƒì˜ ì»¤ë°‹ì´ ìˆë‹¤ë©´ ì¶”ê°€ ì»¤ë°‹ ê°œìˆ˜ í‘œì‹œ
                  if (pr.commits > commits.length) {
                    commitMessages += `... and ${pr.commits - commits.length} more commits.\n`;
                  }
                } else {
                  commitMessages = "No commits found in this PR.\n";
                }

                messageContent = `
                ---
                **Repository:** ${github.repository.full_name}
                **PR Title:** **${pr.title}**
                **Author:** @${pr.user.login}
                **Link:** ${pr.html_url}
                
                ${commitMessages}
                `;

            } else if (action === 'closed') {
                // PRì´ ë‹«í˜”ì„ ë•Œì˜ ì•Œë¦¼ ë¡œì§ (ë³‘í•© ì—¬ë¶€ì— ë”°ë¼ ë‹¤ë¦„)
                if (pr.merged) {
                    messageTitle = `âœ… Pull Request Merged!`;
                    discordColor = 3066993; // ë³‘í•© ì‹œ ë…¹ìƒ‰ (ì•½ê°„ ë‹¤ë¥¸ ë…¹ìƒ‰)
                    messageContent = `
                    ---
                    **Repository:** ${github.repository.full_name}
                    **PR Title:** **${pr.title}**
                    **Merged by:** @${pr.merged_by ? pr.merged_by.login : 'Unknown'}
                    **Link:** ${pr.html_url}
                    `;
                } else {
                    messageTitle = `âŒ Pull Request Closed (Rejected)!`;
                    discordColor = 15548997; // ë³‘í•©ë˜ì§€ ì•Šê³  ë‹«í˜ ì‹œ ë¹¨ê°„ìƒ‰
                    messageContent = `
                    ---
                    **Repository:** ${github.repository.full_name}
                    **PR Title:** **${pr.title}**
                    **Closed by:** @${pr.user.login}
                    **Link:** ${pr.html_url}
                    `;
                }
            } else {
                // ì •ì˜ë˜ì§€ ì•Šì€ ë‹¤ë¥¸ PR ì´ë²¤íŠ¸ëŠ” ë¬´ì‹œ
                console.log(`Unhandled PR event action: ${action}. Exiting.`);
                return;
            }

            // Discord ì›¹í›… URL í™˜ê²½ ë³€ìˆ˜ í™•ì¸
            const discordWebhookUrl = process.env.DISCORD_WEBHOOK_URL;
            if (!discordWebhookUrl) {
                console.log("DISCORD_WEBHOOK_URL secret is not set. Skipping Discord notification.");
                return;
            }
            
            // Discord ì›¹í›…ìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡ (fetch API ì‚¬ìš©)
            await fetch(discordWebhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: 'GitHub Actions Bot', // Discord ë´‡ ì´ë¦„
                    avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png', // ë´‡ ì•„ë°”íƒ€
                    embeds: [{
                        title: messageTitle,       // ì•Œë¦¼ ì„ë² ë“œ ì œëª©
                        url: pr.html_url,          // ì„ë² ë“œ í´ë¦­ ì‹œ ì´ë™í•  URL
                        description: messageContent, // ì„ë² ë“œ ë³¸ë¬¸ ë‚´ìš©
                        color: discordColor,       // ì„ë² ë“œ ìƒ‰ìƒ
                        fields: [                  // ì„ë² ë“œ í•„ë“œ (ì¶”ê°€ ì •ë³´)
                          {
                            name: "Author",
                            value: `@${pr.user.login}`,
                            inline: true
                          },
                          {
                            name: "State",
                            value: pr.state === 'closed' ? (pr.merged ? 'Merged' : 'Closed') : 'Open',
                            inline: true
                          }
                        ],
                        footer: {                  // ì„ë² ë“œ í‘¸í„°
                          text: `PR #${pr.number} in ${github.repository.name}`
                        },
                        timestamp: new Date().toISOString() // í˜„ì¬ ì‹œê°„ ìŠ¤íƒ¬í”„
                    }]
                })
            });
        env:
          # Secretìœ¼ë¡œ ë“±ë¡ëœ Discord ì›¹í›… URLì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì „ë‹¬
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
