name: Pull Request Discord Notification

on:
  pull_request:
    types: [opened, reopened] # PRì´ ì—´ë¦¬ê±°ë‚˜ ë‹¤ì‹œ ì—´ë¦´ ë•Œ ì‹¤í–‰

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 1 # í˜„ì¬ ë¸Œëœì¹˜ì˜ ìµœì‹  ì»¤ë°‹ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤.

      - name: Fetch base branch history
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Get Pull Request details and commits
        id: pr_details
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          PR_BASE_REF="${{ github.event.pull_request.base.ref }}"
          PR_HEAD_REF="${{ github.event.pull_request.head.ref }}"
          REPOSITORY_NAME="${{ github.event.repository.name }}" # ì €ì¥ì†Œ ì´ë¦„ ì¶”ê°€
          REPOSITORY_URL="${{ github.event.repository.html_url }}" # ì €ì¥ì†Œ URL ì¶”ê°€

          COMMITS=$(git log --no-merges --pretty=format:"`%h` %s" origin/"${PR_BASE_REF}"..HEAD)

          COMMITS_LIST=""
          if [ -z "$COMMITS" ]; then
            COMMITS_LIST="*ì»¤ë°‹ ì •ë³´ ì—†ìŒ*"
          else
            # ê° ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ Discord Embed field í˜•ì‹ì— ë§ê²Œ ê°€ê³µí•©ë‹ˆë‹¤.
            # ë°±í‹±(`)ìœ¼ë¡œ ê°ì‹¸ë©´ ì½”ë“œë¡œ ì¸ì‹ë˜ì–´ ë³´ê¸° ì¢‹ìŠµë‹ˆë‹¤.
            COMMITS_LIST=$(echo "$COMMITS" | sed 's/^/\`/' | sed 's/$/\`/')
          fi

          # ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ ë³€ìˆ˜ì— ì €ì¥
          # JSON ë¬¸ìì—´ì— í°ë”°ì˜´í‘œê°€ ë“¤ì–´ê°ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_TITLE=$(echo "$PR_TITLE" | sed 's/"/\\"/g')" >> $GITHUB_ENV
          echo "PR_URL=$PR_URL" >> $GITHUB_ENV
          echo "PR_AUTHOR=$PR_AUTHOR" >> $GITHUB_ENV
          echo "COMMITS_LIST=$(echo "$COMMITS_LIST" | sed 's/"/\\"/g')" >> $GITHUB_ENV
          echo "REPOSITORY_NAME=$(echo "$REPOSITORY_NAME" | sed 's/"/\\"/g')" >> $GITHUB_ENV
          echo "REPOSITORY_URL=$REPOSITORY_URL" >> $GITHUB_ENV


      - name: Send Discord Notification
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PR_NUMBER: ${{ env.PR_NUMBER }}
          PR_TITLE: ${{ env.PR_TITLE }}
          PR_URL: ${{ env.PR_URL }}
          PR_AUTHOR: ${{ env.PR_AUTHOR }}
          COMMITS_LIST: ${{ env.COMMITS_LIST }}
          REPOSITORY_NAME: ${{ env.REPOSITORY_NAME }}
          REPOSITORY_URL: ${{ env.REPOSITORY_URL }}
        with:
          script: |
            const webhookUrl = process.env.DISCORD_WEBHOOK;
            const prNumber = process.env.PR_NUMBER;
            const prTitle = process.env.PR_TITLE;
            const prUrl = process.env.PR_URL;
            const prAuthor = process.env.PR_AUTHOR;
            const commitsList = process.env.COMMITS_LIST;
            const repositoryName = process.env.REPOSITORY_NAME;
            const repositoryUrl = process.env.REPOSITORY_URL;

            // Discord Embed í˜•ì‹ ì •ì˜
            const payload = {
              username: "GitHub PR Notifier",
              avatar_url: "https://avatars.githubusercontent.com/u/9919?s=200&v=4",
              embeds: [
                {
                  title: `âœ¨ ìƒˆë¡œìš´ PR: #${prNumber} - ${prTitle}`, // Embedì˜ ì œëª©
                  url: prUrl, // ì œëª© í´ë¦­ ì‹œ ì´ë™í•  URL
                  description: `**${repositoryName}** ì €ì¥ì†Œì— PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`, // Embedì˜ ì„¤ëª… (ì„ íƒ ì‚¬í•­)
                  color: 5814783, // ë…¹ìƒ‰ (DECIMAL ê°’, HEX #5865F2 (Discord Blurple), #34eb5b (Green))
                  author: {
                    name: `ì‘ì„±ì: ${prAuthor}`,
                    url: `https://github.com/${prAuthor}`, // ì‘ì„±ì í”„ë¡œí•„ ë§í¬
                    icon_url: `https://github.com/${prAuthor}.png?size=32` // ì‘ì„±ì ì•„ë°”íƒ€
                  },
                  fields: [ // ì •ë³´ í•„ë“œ
                    {
                      name: "ğŸ”— PR ë§í¬",
                      value: `[PR #${prNumber}: ${prTitle}](${prUrl})`,
                      inline: false // í•œ ì¤„ ì „ì²´ ì‚¬ìš©
                    },
                    {
                      name: "ğŸ“ í¬í•¨ëœ ì»¤ë°‹",
                      value: commitsList || "*ì»¤ë°‹ ì •ë³´ ì—†ìŒ*", // ì»¤ë°‹ì´ ì—†ìœ¼ë©´ ëŒ€ì²´ ë©”ì‹œì§€
                      inline: false
                    },
                    {
                      name: "ğŸ“¦ ì €ì¥ì†Œ",
                      value: `[${repositoryName}](${repositoryUrl})`,
                      inline: true
                    },
                    {
                      name: "ğŸ‘¤ ì‘ì„±ì",
                      value: `[${prAuthor}](https://github.com/${prAuthor})`,
                      inline: true
                    }
                  ],
                  footer: {
                    text: "GitHub Actions",
                    icon_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                  },
                  timestamp: new Date().toISOString() // í˜„ì¬ ì‹œê°„
                }
              ]
            };

            const response = await fetch(webhookUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Failed to send Discord notification: ${response.status} ${errorText}`);
            }
            console.log('Discord notification sent successfully!');
