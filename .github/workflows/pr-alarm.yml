name: PR Commit Notifier

on:
  pull_request:
    types: [opened, reopened, synchronize, closed] # closed ì´ë²¤íŠ¸ ì¶”ê°€

jobs:
  notify-pr-events: # Job ì´ë¦„ì„ ì¢€ ë” ì¼ë°˜ì ì¸ 'notify-pr-events'ë¡œ ë³€ê²½
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dump GitHub Event Context
        run: |
          echo "github.event:"
          echo "${{ toJSON(github.event) }}"
          echo "github.event.pull_request exists: ${{ github.event.pull_request != null }}"
          # Optionally, if you suspect it's not a PR event, dump event name
          echo "github.event_name: ${{ github.event_name }}"
        # Add a condition to run this step only if the pull_request object is NOT found
        # to focus on the problem runs
        if: github.event.pull_request == null
      
      - name: Send Discord Notification for PR Events
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            if (!github.event || !github.event.pull_request) {
              console.log("github.event or github.event.pull_request is missing. Exiting.");
              // Optionally log the full event object to debug what's coming in
              // console.log(JSON.stringify(github.event, null, 2));
              return; // Exit the script gracefully
            }
            const pr = github.event.pull_request;
            const action = github.event.action; // ì´ë²¤íŠ¸ ì•¡ì…˜ ê°€ì ¸ì˜¤ê¸°

            let messageTitle = "";
            let messageContent = "";
            let discordColor = "";
            let commitMessages = ""; // ì»¤ë°‹ ë©”ì‹œì§€ ë³€ìˆ˜ ì´ˆê¸°í™”

            if (action === 'opened' || action === 'reopened' || action === 'synchronize') {
                // PRì´ ì—´ë¦¬ê±°ë‚˜ ë‹¤ì‹œ ì—´ë¦¬ê±°ë‚˜ ì—…ë°ì´íŠ¸ë˜ì—ˆì„ ë•Œ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
                messageTitle = `ğŸ‰ New Pull Request opened!`;
                discordColor = 65280; // ì´ˆë¡ìƒ‰ (RGB 0, 255, 0)

                const owner = github.repository.owner.login;
                const repo = github.event.repository.name;
                const prNumber = pr.number;

                const { data: commits } = await github.rest.pulls.listCommits({
                  owner,
                  repo,
                  pull_number: prNumber,
                  per_page: 5 
                });

                if (commits.length > 0) {
                  commitMessages = "--- Commits ---\n";
                  commits.forEach(commit => {
                    commitMessages += `- ${commit.commit.message.split('\n')[0].trim()}\n`;
                  });
                  if (pr.commits > commits.length) {
                    commitMessages += `... and ${pr.commits - commits.length} more commits.\n`;
                  }
                } else {
                  commitMessages = "No commits found in this PR.\n";
                }

                messageContent = `
                ---
                **Repository:** ${github.repository.full_name}
                **PR Title:** **${pr.title}**
                **Author:** @${pr.user.login}
                **Link:** ${pr.html_url}
                
                ${commitMessages}
                `;

            } else if (action === 'closed') {
                // PRì´ ë‹«í˜”ì„ ë•Œì˜ ì•Œë¦¼ ë¡œì§
                if (pr.merged) {
                    messageTitle = `Pull Request Merged`;
                    discordColor = 3066993; // ë…¹ìƒ‰ (Merged)
                    messageContent = `
                    ---
                    **Repository:** ${github.repository.full_name}
                    **PR Title:** **${pr.title}**
                    **Merged by:** @${pr.merged_by ? pr.merged_by.login : 'Unknown'}
                    **Link:** ${pr.html_url}
                    `;
                } else {
                    messageTitle = `Pull Request Closed (Rejected)!`;
                    discordColor = 15548997; // ë¹¨ê°„ìƒ‰ (Closed without merge)
                    messageContent = `
                    ---
                    **Repository:** ${github.repository.full_name}
                    **PR Title:** **${pr.title}**
                    **Closed by:** @${pr.user.login}
                    **Link:** ${pr.html_url}
                    `;
                }
            } else {
                console.log(`Unhandled PR event action: ${action}`);
                return; // ë‹¤ë¥¸ PR ì´ë²¤íŠ¸ëŠ” ì•Œë¦¼ ë³´ë‚´ì§€ ì•ŠìŒ
            }

            const discordWebhookUrl = process.env.DISCORD_WEBHOOK_URL;
            if (!discordWebhookUrl) {
                console.log("DISCORD_WEBHOOK_URL secret is not set. Skipping Discord notification.");
                return;
            }
            
            await fetch(discordWebhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: 'GitHub Actions Bot',
                    avatar_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png',
                    embeds: [{
                        title: messageTitle, // ë™ì ìœ¼ë¡œ ë³€ê²½ë˜ëŠ” ì œëª©
                        url: pr.html_url,
                        description: messageContent, // ë™ì ìœ¼ë¡œ ë³€ê²½ë˜ëŠ” ë‚´ìš©
                        color: discordColor, // ë™ì ìœ¼ë¡œ ë³€ê²½ë˜ëŠ” ìƒ‰ìƒ
                        fields: [
                          {
                            name: "Author",
                            value: `@${pr.user.login}`,
                            inline: true
                          },
                          {
                            name: "State", // PR ìƒíƒœ í•„ë“œ ì¶”ê°€
                            value: pr.state === 'closed' ? (pr.merged ? 'Merged' : 'Closed') : 'Open',
                            inline: true
                          }
                        ],
                        footer: {
                          text: `PR #${pr.number} in ${github.repository.name}`
                        },
                        timestamp: new Date().toISOString()
                    }]
                })
            });
